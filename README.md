# How to Develop a Blog Example on Sui

An example of developing a blog_example application based on the Sui platform.

It only requires 30 or so lines of code (all of which is a description of the domain model) to be written by the developer, and then generates a blog example that emulates [RoR Getting Started](https://guides.rubyonrails.org/getting_started.html) in one click, without requiring the developer to write a single line of other code.


## Prerequisites

Currently, the dddappp low-code tool is published as a Docker image for developers to experience.

The off-chain services generated by the tool are written in Java and use the MySQL database by default.

So before getting started, you need to:

* Install [Sui](https://docs.sui.io/build/install).

* Install [Docker](https://docs.docker.com/engine/install/).

* Install MySQL database server.

* Install JDK and Maven. The off-chain services generated by the tool currently use Java.

If you have already installed Docker, you can use Docker to run a MySQL database service. For example:

```shell
sudo docker run -p 3306:3306 --name mysql \
-v ~/docker/mysql/conf:/etc/mysql \
-v ~/docker/mysql/logs:/var/log/mysql \
-v ~/docker/mysql/data:/var/lib/mysql \
-e MYSQL_ROOT_PASSWORD=123456 \
-d mysql:5.7
```


## Programming

### Write DDDML Model File

In the `dddml` directory in the root of the repository, create a DDDML file like this:

```yaml
aggregates:
  Article:
    metadata:
      Preprocessors: ["MOVE_CRUD_IT"]
    id:
      name: Id
      type: UID
    properties:
      Title:
        type: String
        length: 200
      Body:
        type: String
        length: 2000
      Owner:
        type: address
      Comments:
        itemType: Comment
    entities:
      Comment:
        metadata:
          Preprocessors: ["MOVE_CRUD_IT"]
        id:
          name: CommentSeqId
          type: u64
        properties:
          Commenter:
            type: String
            length: 100
          Body:
            type: String
            length: 500
          Owner:
            type: address
```

> **Tip**
>
> About DDDML, here is an introductory article: ["Introducing DDDML: The Key to Low-Code Development for Decentralized Applications"](https://github.com/wubuku/Dapp-LCDP-Demo/blob/main/IntroducingDDDML.md). 


### Run dddappp Project Creation Tool

#### Update dddappp Docker Image

Since the dddappp v0.0.1 image is updated frequently, you may be required to manually delete the image and pull it again before `docker run`.

```shell
# If you have already run it, you may need to Clean Up Exited Docker Containers first
docker rm $(docker ps -aq --filter "ancestor=wubuku/dddappp:0.0.1")
# remove the image
docker image rm wubuku/dddappp:0.0.1
# pull the image
docker pull wubuku/dddappp:0.0.1
```

---

In repository root directory, run:

```shell
docker run \
-v .:/myapp \
wubuku/dddappp:0.0.1 \
--dddmlDirectoryPath /myapp/dddml \
--boundedContextName Test.SuiBlogExample \
--suiMoveProjectDirectoryPath /myapp/sui-contracts \
--boundedContextSuiPackageName sui_blog_example \
--boundedContextJavaPackageName org.test.suiblogexample \
--javaProjectsDirectoryPath /myapp/sui-java-service \
--javaProjectNamePrefix suiblogexample \
--pomGroupId test.suiblogexample
```

The command parameters above are straightforward:

* This line `-v .:/myapp \` indicates mounting the local current directory into the `/myapp` directory inside the container.
* `dddmlDirectoryPath` is the directory where the DDDML model files are located. It should be a directory path that can be read in the container.
* Understand the value of the `boundedContextName` parameter as the name of the application you want to develop. When the name has multiple parts, separate them with dots and use the PascalCase naming convention for each part. Bounded-context is a term in Domain-driven design (DDD) that refers to a specific problem domain scope that contains specific business boundaries, constraints, and language. If you cannot understand this concept for the time being, it is not a big deal.
* `boundedContextJavaPackageName` is the Java package name of the off-chain service. According to Java naming conventions, it should be all lowercase and the parts should be separated by dots.
* `boundedContextSuiPackageName` is the package name of the on-chain Sui contracts. According to the Sui development convention, it should be named in snake_case style with all lowercase letters.
* `javaProjectsDirectoryPath` is the directory path where the off-chain service code is placed. The off-chain service consists of multiple modules (projects). It should be a readable and writable directory path in the container.
* `javaProjectNamePrefix` is the name prefix of each module of the off-chain service. It is recommended to use an all-lowercase name.
* `pomGroupId` is the GroupId of the off-chain service. We use Maven as the project management tool for off-chain service. It should be all lowercase and the parts should be separated by dots.
* `suiMoveProjectDirectoryPath` is the directory path where the on-chain Sui contract code is placed. It should be a readable and writable directory path in the container.

After the above command is successfully executed, two directories `sui-java-service` and `sui-contracts` should be added to the local current directory.

Now you can try to compile the off-chain service. Go to the directory `sui-java-service` and run:

```shell
mvn compile
```

If there is no unexpected failure, the compilation should be successful.


### Implementing Business Logic

If CRUD is all the business logic you need, You **don't** need to write a single line of code other than the DDDML model above. You **can skip this section** and just start testing your example application.

The tool has generated some files with the suffix `_logic.move` in the directory `sui-contracts/sources`. 

Generally, these files contain the scaffolding code of functions that implement business logic, namely the signature part of the functions. You just need to fill in the implementation part of the functions. However, in this example, the `MOVE_CRUD_IT` preprocessor already generates the full CRUD methods for us.

---

It is possible that you feel that the default generated CRUD logic does not meet your needs.

For example, you might want to use `Owner` fields of `Article` and `Comment` to control who can update/delete articles and comments. Then, you may want to add comment without passing the `Owner` argument to `entry fun add_comment` and directly use the sender account address as the owner.

This requirement can currently be satisfied as follows.

First, modify DDDML model file and define a custom method like this:

```yaml
aggregates:
  Article:
    # ...
    entities:
      Comment:
        metadata:
          Preprocessors: ["MOVE_CRUD_IT"]
    # ...
    methods:
      AddComment:
        event:
          name: CommentAdded
          properties:
            Owner:
              type: address
        parameters:
          CommentSeqId:
            type: u64
          Commenter:
            type: String
            length: 100
          Body:
            type: String
            length: 500
```

Note that the `Owner` parameter is NOT present in the method parameters above.

Then, delete `article_add_comment_logic.move`, run the dddappp tool again. (Since the dddappp tool does not overwrite the `*_logic.move` files by default, you will need to delete it manually.)

Open the regenerated `article_add_comment_logic.move` file, find the `verify` function and fill in the body with the logic you want.


## Test Example

### Publish the Sui contract

Execute the following command in the directory `sui-contracts` to publish the contract on chain:

```shell
sui client publish --gas-budget 1000000000 --skip-dependency-verification
```

If the command is executed successfully, the transaction digest of this publication will be output. For example:

```*shell
*----- Transaction Digest ----
3yydwTgzKJ9nQ6bEXQaacHQFyDRaMi924mWMGoFFat83
----- Transaction Data ----
#...
```

Take note of this transaction digest, for example, `3yydwTgzKJ9nQ6bEXQaacHQFyDRaMi924mWMGoFFat83`.


### Configuring Off-Chain Service

Open the `application-test.yml` file located in the directory `sui-java-service/suiblogexample-service-rest/src/main/resources` and set the published transaction digest.

After setting, it should look like this:

```yaml
sui:
  contract:
    jsonrpc:
      url: "https://fullnode.testnet.sui.io/"
      #url: "http://localhost:9000"
    package-publish-transaction: "3yydwTgzKJ9nQ6bEXQaacHQFyDRaMi924mWMGoFFat83"
```

This is the only place where off-chain service need to be configured, and it's that simple.


### Creating a Database for Off-Chain Service

Use a MySQL client to connect to the local MySQL server and execute the following script to create an empty database (assuming the name is `test2`):

```sql
CREATE SCHEMA `test2` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;
```

Go to the `sui-java-service` directory and package the Java project:

```shell
mvn package
```

Then, run a command-line tool to initialize the database:

```shell
java -jar ./suiblogexample-service-cli/target/suiblogexample-service-cli-0.0.1-SNAPSHOT.jar ddl -d "./scripts" -c "jdbc:mysql://127.0.0.1:3306/test2?enabledTLSProtocols=TLSv1.2&characterEncoding=utf8&serverTimezone=GMT%2b0&useLegacyDatetimeCode=false" -u root -p 123456
```

### Starting Off-Chain Service

In the `sui-java-service` directory, run the following command to start the off-chain service:

```shell
mvn -pl suiblogexample-service-rest -am spring-boot:run
```

### Tip: Using this Cheatsheet

After the off-chain services are started, you can access this URL to get a cheatsheet on how to use the Sui Client CLI to call on-chain contracts: http://localhost:1023/api/sui.contract/SuiClientCLICheatsheet.md

In the cheatsheet, the Package Id of the contracts you just published and the Object Ids (created according to the Id Generators declared in models) you need when creating certain entities are already filled in for you. The parameters you need to fill in are placeholders containing their type and meaning (name). You can copy these commands, modify them as needed, and execute them directly in a terminal.

### CRUD Articles

Here we assume that the published package ID of the contracts is `0xdc93d426b0a5ceaa8a883776c34370f83af72df528e8c9229a4febe2dc1b3b60` (Replace it with your actual published package ID when you do your tests).

#### Create Articles

You can create an article like this (you need to replace the placeholder `{ACCOUNT_ADDRESS}` with your account address):

```shell
sui client call --package 0xdc93d426b0a5ceaa8a883776c34370f83af72df528e8c9229a4febe2dc1b3b60 --module article_aggregate --function create \
--args \"Hello\" \"World\" {ACCOUNT_ADDRESS} \
--gas-budget 10000000
```

Then you can change the content of the first parameter (`title`) and the second parameter (`body`) after `--args`, and create a few more articles.

#### Read Articles

You can access the off-chain service RESTful API to get information about articles that have been created: http://localhost:1023/api/Articles

You can use parameters to filter articles, such as: http://localhost:1023/api/Articles?title=Hello

#### Update Articles

Let's assume that the object ID of an article you just created is `0xd31224eac22bfd66de709d521f337acf65a026e5fe16218ceae3a1843df5eaec`.

You can update an article like this: (Note that the first argument after `--args` is the object ID of the article, please replace it with the actual value.)

```shell
sui client call --package 0xdc93d426b0a5ceaa8a883776c34370f83af72df528e8c9229a4febe2dc1b3b60 --module article_aggregate --function update \
--args 0xd31224eac22bfd66de709d521f337acf65a026e5fe16218ceae3a1843df5eaec \"Hello\" '"My friends."' {ACCOUNT_ADDRESS} \
--gas-budget 10000000
```

You can use the Sui Client CLI to query information about an object like this:

```shell
sui client object 0xd31224eac22bfd66de709d521f337acf65a026e5fe16218ceae3a1843df5eaec
```

#### Delete Articles

You can delete an article like this: (Note that the first argument after `--args` is the object ID of the article, please replace it with the actual value.)

```shell
sui client call --package 0xdc93d426b0a5ceaa8a883776c34370f83af72df528e8c9229a4febe2dc1b3b60 --module article_aggregate --function delete \
--args 0xd31224eac22bfd66de709d521f337acf65a026e5fe16218ceae3a1843df5eaec \
--gas-budget 10000000
```

### CRUD Comments

#### Add Comments

First, get the object ID  of another article (the article that was not deleted).

You can add a comment like this: (Note that the first argument after `--args` is the object ID of an article, please replace it with the actual value.)

```shell
sui client call --package 0xdc93d426b0a5ceaa8a883776c34370f83af72df528e8c9229a4febe2dc1b3b60 --module article_aggregate --function add_comment \
--args 0xf05e0623bb54630d2b78f2ae186babcd62585296a5ae2a002a2017a4eeaafd6b \"1\" \"Anonymous\" '"A test comment"' \
--gas-budget 10000000
```

Add more comment like this:

```shell
sui client call --package 0xdc93d426b0a5ceaa8a883776c34370f83af72df528e8c9229a4febe2dc1b3b60 --module article_aggregate --function add_comment \
--args 0xf05e0623bb54630d2b78f2ae186babcd62585296a5ae2a002a2017a4eeaafd6b \"2\" \"Anonymous2\" '"A test comment2"' \
--gas-budget 10000000
```

#### Read Comments

You can access the off-chain service RESTful API to get information about comments of an article:

```shell
curl http://localhost:1023/api/Articles/0xf05e0623bb54630d2b78f2ae186babcd62585296a5ae2a002a2017a4eeaafd6b
```

#### Update Comments

We can submit a transaction like this to update a comment:

```shell
sui client call --package 0xdc93d426b0a5ceaa8a883776c34370f83af72df528e8c9229a4febe2dc1b3b60 --module article_aggregate --function update_comment \
--args 0xf05e0623bb54630d2b78f2ae186babcd62585296a5ae2a002a2017a4eeaafd6b \"1\" \"Anonymous\" '"A test comment from Anonymous"' {ACCOUNT_ADDRESS} \
--gas-budget 10000000
```

Then we can query the comment state again to see if the comment content has been updated.

#### Remove Comments

We can submit a transaction like this to delete a comment:

```shell
sui client call --package 0xdc93d426b0a5ceaa8a883776c34370f83af72df528e8c9229a4febe2dc1b3b60 --module article_aggregate --function remove_comment \
--args 0xf05e0623bb54630d2b78f2ae186babcd62585296a5ae2a002a2017a4eeaafd6b \"1\" \
--gas-budget 10000000
```


## Some Tips

### Clean Up Exited Docker Containers

Run the command:

```shell
docker rm $(docker ps -aq --filter "ancestor=wubuku/dddappp:0.0.1")
```

### A More Complex Sui Demo

If you are interested, you can find a more complex Sui Demo here: ["A Sui Demo"](https://github.com/dddappp/A-Sui-Demo).

### Blog Example for Rooch

Here is a Rooch version like this blog example: https://github.com/rooch-network/rooch/blob/main/examples/blog/README.md

